<div id="top" class="container mx-auto max-w-7xl p-4 space-y-6">
  <!-- 1. Cargar CV -->
  <mat-card appearance="outlined" class="upload-card">
    <h2 class="card-title"><mat-icon>upload</mat-icon> Cargar CV</h2>
    <label class="upload-dropzone">
      <input type="file" accept=".pdf" hidden (change)="onCv($event)" />
      <mat-icon class="upload-icon">cloud_upload</mat-icon>
      <span>Arrastra o haz clic para subir PDF</span>
    </label>
    <p *ngIf="cvName" class="upload-ok">
      <mat-icon>check_circle</mat-icon> {{ cvName }}
    </p>
  </mat-card>

  <!-- 2. Oferta + Ajustes -->
  <div class="offer-config">
    <mat-card appearance="outlined" class="offer-box">
      <h2 class="card-title">
        <mat-icon>work</mat-icon> Información de la oferta
      </h2>
      <textarea
        matInput
        rows="10"
        [(ngModel)]="offerText"
        placeholder="Pega aquí…"
      ></textarea>
    </mat-card>

    <mat-card appearance="outlined" class="config-box">
      <h2 class="card-title"><mat-icon>translate</mat-icon> Configuración</h2>
      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Idioma</mat-label>
        <mat-select [(ngModel)]="language">
          <mat-option value="es">Español</mat-option>
          <mat-option value="en">Inglés</mat-option>
          <mat-option value="fr">Francés</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Tono</mat-label>
        <mat-select [(ngModel)]="tone">
          <mat-option value="formal">Formal</mat-option>
          <mat-option value="profesional">Profesional</mat-option>
          <mat-option value="cercano">Cercano</mat-option>
        </mat-select>
      </mat-form-field>
    </mat-card>
  </div>

  <mat-card appearance="outlined" class="actions">
    <!-- Botón Generar CV -->
    <button
      mat-raised-button
      color="primary"
      (click)="generateCv()"
      [disabled]="!cvName || generatingCv"
    >
      <mat-icon>description</mat-icon>
      <ng-container *ngIf="!generatingCv">Generar CV adaptado</ng-container>
      <ng-container *ngIf="generatingCv">Generando CV…</ng-container>
    </button>

    <!-- Botón Generar carta -->
    <button
      mat-raised-button
      color="accent"
      (click)="generateLetter()"
      [disabled]="!offerText || generatingLetter"
    >
      <mat-icon>drafts</mat-icon>
      <ng-container *ngIf="!generatingLetter"
        >Generar carta de Presentación</ng-container
      >
      <ng-container *ngIf="generatingLetter">Generando carta…</ng-container>
    </button>
  </mat-card>

  <!-- 3-b Resultados ---------------------------------------------------- -->
  <ng-container *ngIf="generatedCvText || generatedLetter">
    <mat-card
      appearance="outlined"
      *ngIf="generatedCvText"
      class="p-4 space-y-2"
    >
      <h3 class="font-semibold flex items-center gap-2">
        <mat-icon>article</mat-icon> CV adaptado
      </h3>
      <textarea readonly rows="12" class="w-full border rounded p-2">
        {{ generatedCvText }}</textarea
      >
    </mat-card>

    <mat-card
      appearance="outlined"
      *ngIf="generatedLetter"
      class="p-4 space-y-2"
    >
      <h3 class="font-semibold flex items-center gap-2">
        <mat-icon>article</mat-icon> Carta generada
      </h3>
      <textarea readonly rows="10" class="w-full border rounded p-2">{{
        generatedLetter
      }}</textarea>
    </mat-card>
  </ng-container>

  <!-- 4. Chat entrevista ----------------------------------------------- -->
  <mat-card id="interview-section" appearance="outlined" class="interview-card">
    <div class="flex items-center gap-4 flex-wrap">
      <h2 class="text-xl font-semibold flex items-center gap-2 m-0">
        <mat-icon>chat</mat-icon> Entrevista simulada
      </h2>

      <mat-form-field appearance="fill" class="w-40">
        <mat-label>Nivel</mat-label>
        <mat-select [(ngModel)]="level">
          <mat-option value="principiante">Principiante</mat-option>
          <mat-option value="medio">Medio</mat-option>
          <mat-option value="avanzado">Avanzado</mat-option>
        </mat-select>
      </mat-form-field>

      <button
        mat-stroked-button
        color="primary"
        (click)="startInterview()"
        [disabled]="
          interviewActive || !parsedCv || !offerText || interviewLoading
        "
      >
        <mat-icon>play_arrow</mat-icon>
        <ng-container *ngIf="!interviewLoading"
          >Iniciar entrevista</ng-container
        >
        <ng-container *ngIf="interviewLoading"
          >Preparando entrevista…</ng-container
        >
      </button>

      <button
        mat-stroked-button
        color="warn"
        (click)="endInterview()"
        [disabled]="!interviewActive"
      >
        <mat-icon>stop</mat-icon> Terminar
      </button>
    </div>
    <!-- ← único cierre del div de cabecera -->

    <!-- ventana chat -->
    <div class="border rounded h-64 overflow-y-auto p-2 space-y-2 bg-slate-50">
      <div
        *ngFor="let m of chat"
        [ngClass]="{
          'text-right': m.from === 'user',
          'text-left': m.from === 'bot'
        }"
      >
        <span
          class="inline-block px-3 py-1 rounded-lg"
          [ngClass]="
            m.from === 'user' ? 'bg-blue-600 text-white' : 'bg-white border'
          "
        >
          {{ m.text }}
        </span>
      </div>
    </div>

    <!-- input -->
    <form (submit)="sendMsg()" class="flex gap-2">
      <input
        matInput
        placeholder="Escribe tu respuesta…"
        [(ngModel)]="chatInput"
        name="msg"
        class="flex-1 border rounded p-2"
      />
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="!chatInput.trim()"
      >
        Enviar
      </button>
    </form>

    <!-- feedback -->
    <div *ngIf="lastFeedback" class="text-sm text-gray-500">
      <mat-icon inline>info</mat-icon>
      <strong>Feedback:</strong> {{ lastFeedback }}
      <span *ngIf="lastScore !== null">
        – Puntuación: {{ lastScore | number : "1.0-2" }}
      </span>
    </div>
  </mat-card>
</div>
